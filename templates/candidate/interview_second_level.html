{% extends "home.html" %}
{% block content %}
{% include "navbar.html" %}

<div class="min-h-screen bg-blue-50 py-16 px-6">

  <div class="max-w-3xl mx-auto bg-white shadow-xl rounded-2xl p-8">

    <h2 class="text-3xl font-bold text-blue-700 mb-6 text-center">
      üé§ Voice Interview ‚Äì Level 2
    </h2>

    <p class="text-gray-600 text-center mb-8">
      Answer each question within <span class="font-semibold text-blue-600">60 seconds</span>.
    </p>

    <!-- QUESTION BOX -->
    <div class="bg-blue-100 p-6 rounded-xl mb-6 shadow-inner">
      <h3 id="question_text"
          class="text-xl font-semibold text-gray-800 text-center opacity-0 transition-opacity duration-500">
      </h3>
    </div>

    <!-- CIRCULAR TIMER -->
    <div class="flex justify-center mb-8">
      <div class="relative w-28 h-28">

        <!-- circle background -->
        <svg class="absolute inset-0 w-full h-full">
          <circle cx="56" cy="56" r="50" stroke="#d1d5db" stroke-width="8" fill="none"></circle>
          <circle id="timerCircle" cx="56" cy="56" r="50"
              stroke="#2563eb" stroke-width="8" fill="none"
              stroke-linecap="round"
              stroke-dasharray="314"
              stroke-dashoffset="0"
              transform="rotate(-90 56 56)">
          </circle>
        </svg>

        <div class="absolute inset-0 flex items-center justify-center">
          <span id="timer" class="text-3xl font-bold text-blue-700">60</span>
        </div>

      </div>
    </div>

    <!-- MIC BUTTONS -->
    <div class="flex justify-center gap-4 mb-6">

      <!-- Start Button with Ripple -->
      <button id="startBtn"
              class="relative px-8 py-3 bg-blue-600 text-white font-semibold rounded-xl shadow hover:bg-blue-700 transition">

        <span class="relative z-10">üéôÔ∏è Start Recording</span>

        <span id="rippleMic"
              class="absolute inset-0 rounded-xl bg-blue-400 opacity-0 animate-none">
        </span>
      </button>

      <!-- Stop -->
      <button id="stopBtn"
              class="px-8 py-3 bg-red-600 text-white font-semibold rounded-xl shadow hover:bg-red-700 transition"
              disabled>
        ‚õî Stop
      </button>

    </div>

    <!-- TRANSCRIPT BOX -->
    <div id="transcript_box"
         class="bg-gray-50 p-4 rounded-lg border border-gray-200 mb-4 hidden opacity-0 transition-opacity duration-500">
      <p class="font-semibold text-gray-700 mb-1">Transcript:</p>
      <p id="transcript_output" class="text-gray-800"></p>
    </div>

    <!-- NEXT BUTTON -->
    <div class="flex justify-center">
      <button id="nextBtn"
              class="px-6 py-3 bg-blue-700 text-white font-semibold rounded-xl shadow hover:bg-blue-800 transition
                     hidden opacity-0 translate-y-3">
        Next Question ‚Üí
      </button>
    </div>

  </div>
</div>

<style>
/* Mic Ripple Animation */
#rippleMic.recording {
  animation: micRipple 1.2s infinite;
}

@keyframes micRipple {
  0% { transform: scale(1); opacity: 0.4; }
  70% { transform: scale(1.3); opacity: 0; }
  100% { transform: scale(1); opacity: 0; }
}

/* Typing Effect */
.typing {
  overflow: hidden;
  white-space: nowrap;
  border-right: 3px solid #2563eb;
  animation: typing 2s steps(40), blink 0.6s infinite alternate;
}
@keyframes typing {
  from { width: 0; }
  to { width: 100%; }
}
@keyframes blink {
  0% { border-color: transparent; }
  100% { border-color: #2563eb; }
}

/* Slide In Next Button */
.showNext {
  opacity: 1 !important;
  transform: translateY(0) !important;
  transition: all 0.4s ease-out;
}
</style>

<script>
let session_id = null;
let questions = [];
let currentIndex = 0;

let mediaRecorder = null;
let audioChunks = [];
let stream = null;
let countdownInterval = null;

// ---------------------------------------
// START INTERVIEW
// ---------------------------------------
function startSession() {
    fetch("/start-interview/")
    .then(res => res.json())
    .then(data => {
        session_id = data.session_id;
        questions = data.questions;
        currentIndex = 0;
        displayQuestion();
    });
}
startSession();

// ---------------------------------------
// DISPLAY QUESTION WITH TYPING EFFECT
// ---------------------------------------
function displayQuestion() {
    if (currentIndex >= questions.length) {
        evaluateInterview();
        return;
    }

    let qt = document.getElementById("question_text");
    qt.classList.remove("typing");
    qt.style.opacity = "0";

    setTimeout(() => {
        qt.innerText = questions[currentIndex];
        qt.classList.add("typing");
        qt.style.opacity = "1";
    }, 200);

    document.getElementById("transcript_box").classList.add("hidden");
    document.getElementById("nextBtn").classList.add("hidden");
    document.getElementById("nextBtn").classList.remove("showNext");

    resetButtons();
    startTimer();
}

// ---------------------------------------
// RESET BUTTONS
// ---------------------------------------
function resetButtons() {
    document.getElementById("startBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
}

// ---------------------------------------
// TIMER + CIRCLE ANIMATION
// ---------------------------------------
function startTimer() {
    let timeLeft = 60;
    let circle = document.getElementById("timerCircle");
    let totalLength = 314;

    clearInterval(countdownInterval);

    countdownInterval = setInterval(() => {
        timeLeft--;
        document.getElementById("timer").innerText = timeLeft;

        let offset = totalLength * (1 - timeLeft / 60);
        circle.style.strokeDashoffset = offset;

        if (timeLeft <= 0) stopRecording();
    }, 1000);
}

// ---------------------------------------
// START RECORDING
// ---------------------------------------
document.getElementById("startBtn").onclick = async () => {
    try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });

        audioChunks = [];
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
            uploadAudio();
            stopStream();
        };

        mediaRecorder.start();

        document.getElementById("startBtn").disabled = true;
        document.getElementById("stopBtn").disabled = false;

        // Mic Ripple ON
        document.getElementById("rippleMic").classList.add("recording");

    } catch (err) {
        alert("Microphone error: " + err);
    }
};

// ---------------------------------------
// STOP RECORDING
// ---------------------------------------
document.getElementById("stopBtn").onclick = () => stopRecording();

function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
    }

    document.getElementById("stopBtn").disabled = true;
    document.getElementById("rippleMic").classList.remove("recording");

    clearInterval(countdownInterval);
}

// Close mic stream
function stopStream() {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
    }
}

// ---------------------------------------
// UPLOAD AUDIO
// ---------------------------------------
function uploadAudio() {
    const blob = new Blob(audioChunks, { type: "audio/webm" });

    let formData = new FormData();
    formData.append("audio", blob, "recording.webm");

    fetch("/process-audio/", { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
        let transcript = data.transcript || "[No speech detected]";

        let box = document.getElementById("transcript_box");
        box.classList.remove("hidden");

        setTimeout(() => { box.style.opacity = "1"; }, 50);

        document.getElementById("transcript_output").innerText = transcript;

        saveAnswer(transcript);
    });
}

// ---------------------------------------
// SAVE ANSWER
// ---------------------------------------
function saveAnswer(transcript) {
    fetch("/save-answer/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            question: questions[currentIndex],
            transcript: transcript,
            session_id: session_id
        })
    })
    .then(res => res.json())
    .then(() => {
        let nextBtn = document.getElementById("nextBtn");
        nextBtn.classList.remove("hidden");

        setTimeout(() => {
            nextBtn.classList.add("showNext");
        }, 100);
    });
}

// NEXT QUESTION
document.getElementById("nextBtn").onclick = () => {
    currentIndex++;
    displayQuestion();
};

// END SESSION
function evaluateInterview() {
    window.location.href = "/evaluate-session/" + session_id + "/";
}
</script>

{% endblock %}
